<?xml version="1.0"?>
<project name="AkeebaSubscriptions" description="Akeeba Subscriptions component based on Nooku FW" default="svn" >
	<property file="./build.properties" />
	<!-- Default properties, set only if not already assigned in the build.properties file -->
	<property name="dirs.root" value="../" />
	<property name="dirs.component" value="../component" />
	<property name="dirs.modules" value="../modules" />
	<property name="dirs.plugins" value="../plugins" />
	<property name="dirs.documentation" value="../documentation" />
	<property name="dirs.koowa" value="../koowa/code" />

	<property name="dirs.release" value="../release" />

	<property name="dirs.bin" value="bin" />
	<property name="dirs.bin.libxml" value="${dirs.bin}/libxml" />
	<property name="dirs.bin.fop" value="${dirs.bin}/fop" />
	<property name="dirs.bin.dbxsl" value="${dirs.bin}/dbxsl" />

	<property name="version" value="svn" />

	<taskdef name="zipme" classname="phingext.ZipmeTask" />
	<taskdef name="svnversion" classname="phingext.SvnVersionTask" />
	<taskdef name="docexport" classname="phingext.DocexportTask" />

	<!--
	====================================================================================================
	File sets
	====================================================================================================
	-->
	
	<fileset dir="${dirs.component}" id="component">
		<include name="backend/**" />
		<include name="frontend/**" />
		<include name="media/**" />
		<include name="translations/**" />
		<include name="*" />
	</fileset>

	<!--
	====================================================================================================
	Tasks - General
	====================================================================================================
	-->
	
	<target name="all" description="Makes everything"
		depends="svn,documentation">
	</target>

	<target name="svn" description="Makes only packages, not the documentation"
		depends="new-release,setup-properties,component-packages">
	</target>

	<target name="new-release" description="Create the release directory afresh">
		<!-- Recreate the release directory -->
		<delete dir="${dirs.release}" quiet="yes" includeemptydirs="false" />
		<mkdir dir="${dirs.release}" />
	</target>
	
	<target name="setup-properties" description="Set up version and build properties">
		<!-- Initialize the build.date timestamp -->
		<tstamp>
			<format property="build.date" pattern="%Y-%m-%d" />
		</tstamp>

		<!-- Initialize the version if it's not set -->
		<if>
			<equals arg1="${version}" arg2="svn" />
			<then>
				<svnversion workingcopy="${dirs.root}" propertyname="svn.lastrevision" />
				<property name="version" value="svn${svn.lastrevision}" override="true" />
			</then>
		</if>
	</target>

	<!--
	====================================================================================================
	Tasks - Joomla! packages
	====================================================================================================
	-->
	
	<target name="component-packages" depends="component-package-core-full,component-package-core-nofw,component-package-pro-nofw,component-package-pro-full" />
	
	<target name="component-package-core-full" description="Akeeba Subscriptions Core, full"
		depends="new-release,setup-properties">
			
		<!-- Create the package -->
		<copy file="./templates/akeebasubs.xml" tofile="${dirs.component}/akeebasubs.xml" overwrite="true">
			<filterchain>
				<replacetokens begintoken="##" endtoken="##">
					<token key="DATE" value="${build.date}" />
					<token key="VERSION" value="${version}" />
				</replacetokens>
			</filterchain>
		</copy>
		
		<copy file="./templates/version.php" tofile="${dirs.component}/backend/version.php" overwrite="true">
			<filterchain>
				<replacetokens begintoken="##" endtoken="##">
					<token key="DATE" value="${build.date}" />
					<token key="VERSION" value="${version}" />
					<token key="PRO" value="0" />
				</replacetokens>
			</filterchain>
		</copy>
		
		<zipme basedir="${dirs.component}" destfile="${dirs.release}/com_akeebasubs-core-${version}-full.zip" includeemptydirs="true">
			<fileset refid="component" />
		</zipme>
		<zipme basedir="${dirs.modules}" prefix="modules/" destfile="${dirs.release}/com_akeebasubs-core-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.modules}">
				<include name="**"/>
			</fileset>
		</zipme>
		<zipme basedir="${dirs.plugins}" prefix="plugins/" destfile="${dirs.release}/com_akeebasubs-core-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.plugins}">
				<include name="**"/>
				<exclude name="akeebasubs/docman**" />
				<exclude name="akeebasubs/jce**" />
				<exclude name="akeebasubs/k2**" />
				<exclude name="akeebasubs/ninjaboard**" />
				<exclude name="akeebasubs/vm**" />
				<exclude name="akeebasubs/cb**" />
				<exclude name="akeebasubs/tienda**" />
                                <exclude name="akpayment/worldpay**" />
			</fileset>
		</zipme>
		
		<zipme basedir="${dirs.koowa}" prefix="koowa" destfile="${dirs.release}/com_akeebasubs-core-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.koowa}">
				<include name="**"/>
				<exclude name="site/**" />
				<exclude name="plugins/system/**" />
			</fileset>
		</zipme>
		<zipme basedir="${dirs.koowa}/site" prefix="koowa" destfile="${dirs.release}/com_akeebasubs-core-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.koowa}/site">
				<include name="**"/>
			</fileset>
		</zipme>
		<zipme basedir="${dirs.koowa}/plugins/system" prefix="plugins/system/koowa" destfile="${dirs.release}/com_akeebasubs-core-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.koowa}/plugins/system">
				<include name="koowa.php"/>
			</fileset>
		</zipme>
		<copy file="./templates/koowa.xml" tofile="${dirs.release}/koowa.xml" overwrite="true" />
		<zipme basedir="${dirs.release}" prefix="plugins/system/koowa" destfile="${dirs.release}/com_akeebasubs-core-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.release}">
				<include name="koowa.xml"/>
			</fileset>
		</zipme>
	</target>
	
	<target name="component-package-core-nofw" description="Akeeba Subscriptions Core, without Nooku"
		depends="new-release,setup-properties">
		
		<copy file="./templates/akeebasubs.xml" tofile="${dirs.component}/akeebasubs.xml" overwrite="true">
			<filterchain>
				<replacetokens begintoken="##" endtoken="##">
					<token key="DATE" value="${build.date}" />
					<token key="VERSION" value="${version}" />
				</replacetokens>
			</filterchain>
		</copy>
		
		<copy file="./templates/version.php" tofile="${dirs.component}/backend/version.php" overwrite="true">
			<filterchain>
				<replacetokens begintoken="##" endtoken="##">
					<token key="DATE" value="${build.date}" />
					<token key="VERSION" value="${version}" />
					<token key="PRO" value="0" />
				</replacetokens>
			</filterchain>
		</copy>
		
		<zipme basedir="${dirs.component}" destfile="${dirs.release}/com_akeebasubs-core-${version}-no_framework.zip" includeemptydirs="true">
			<fileset refid="component" />
		</zipme>
		<zipme basedir="${dirs.modules}" prefix="modules/" destfile="${dirs.release}/com_akeebasubs-core-${version}-no_framework.zip" includeemptydirs="true">
			<fileset dir="${dirs.modules}">
				<include name="**"/>
			</fileset>
		</zipme>
		<zipme basedir="${dirs.plugins}" prefix="plugins/" destfile="${dirs.release}/com_akeebasubs-core-${version}-no_framework.zip" includeemptydirs="true">
			<fileset dir="${dirs.plugins}">
				<include name="**"/>
				<exclude name="akeebasubs/docman**" />
				<exclude name="akeebasubs/jce**" />
				<exclude name="akeebasubs/k2**" />
				<exclude name="akeebasubs/ninjaboard**" />
				<exclude name="akeebasubs/vm**" />
				<exclude name="akeebasubs/cb**" />
				<exclude name="akeebasubs/tienda**" />
                                <exclude name="akpayment/worldpay**" />
			</fileset>
		</zipme>
	</target>
	
	<target name="component-package-pro-full" description="Akeeba Subscriptions Professional, full"
		depends="new-release,setup-properties">
			
		<!-- Create the package -->
		<copy file="./templates/akeebasubs.xml" tofile="${dirs.component}/akeebasubs.xml" overwrite="true">
			<filterchain>
				<replacetokens begintoken="##" endtoken="##">
					<token key="DATE" value="${build.date}" />
					<token key="VERSION" value="${version}" />
				</replacetokens>
			</filterchain>
		</copy>
		
		<copy file="./templates/version.php" tofile="${dirs.component}/backend/version.php" overwrite="true">
			<filterchain>
				<replacetokens begintoken="##" endtoken="##">
					<token key="DATE" value="${build.date}" />
					<token key="VERSION" value="${version}" />
					<token key="PRO" value="1" />
				</replacetokens>
			</filterchain>
		</copy>
		
		<zipme basedir="${dirs.component}" destfile="${dirs.release}/com_akeebasubs-pro-${version}-full.zip" includeemptydirs="true">
			<fileset refid="component" />
		</zipme>
		<zipme basedir="${dirs.modules}" prefix="modules/" destfile="${dirs.release}/com_akeebasubs-pro-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.modules}">
				<include name="**"/>
			</fileset>
		</zipme>
		<zipme basedir="${dirs.plugins}" prefix="plugins/" destfile="${dirs.release}/com_akeebasubs-pro-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.plugins}">
				<include name="**"/>
			</fileset>
		</zipme>
		
		<zipme basedir="${dirs.koowa}" prefix="koowa" destfile="${dirs.release}/com_akeebasubs-pro-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.koowa}">
				<include name="**"/>
				<exclude name="site/**" />
				<exclude name="plugins/system/**" />
			</fileset>
		</zipme>
		<zipme basedir="${dirs.koowa}/site" prefix="koowa" destfile="${dirs.release}/com_akeebasubs-pro-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.koowa}/site">
				<include name="**"/>
			</fileset>
		</zipme>
		<zipme basedir="${dirs.koowa}/plugins/system" prefix="plugins/system/koowa" destfile="${dirs.release}/com_akeebasubs-pro-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.koowa}/plugins/system">
				<include name="koowa.php"/>
			</fileset>
		</zipme>
		<copy file="./templates/koowa.xml" tofile="${dirs.release}/koowa.xml" overwrite="true" />
		<zipme basedir="${dirs.release}" prefix="plugins/system/koowa" destfile="${dirs.release}/com_akeebasubs-pro-${version}-full.zip" includeemptydirs="true">
			<fileset dir="${dirs.release}">
				<include name="koowa.xml"/>
			</fileset>
		</zipme>
	</target>
	
	<target name="component-package-pro-nofw" description="Akeeba Subscriptions Professional, without Nooku"
		depends="new-release,setup-properties">
		
		<copy file="./templates/akeebasubs.xml" tofile="${dirs.component}/akeebasubs.xml" overwrite="true">
			<filterchain>
				<replacetokens begintoken="##" endtoken="##">
					<token key="DATE" value="${build.date}" />
					<token key="VERSION" value="${version}" />
				</replacetokens>
			</filterchain>
		</copy>
		
		<copy file="./templates/version.php" tofile="${dirs.component}/backend/version.php" overwrite="true">
			<filterchain>
				<replacetokens begintoken="##" endtoken="##">
					<token key="DATE" value="${build.date}" />
					<token key="VERSION" value="${version}" />
					<token key="PRO" value="1" />
				</replacetokens>
			</filterchain>
		</copy>
		
		<zipme basedir="${dirs.component}" destfile="${dirs.release}/com_akeebasubs-pro-${version}-no_framework.zip" includeemptydirs="true">
			<fileset refid="component" />
		</zipme>
		<zipme basedir="${dirs.modules}" prefix="modules/" destfile="${dirs.release}/com_akeebasubs-pro-${version}-no_framework.zip" includeemptydirs="true">
			<fileset dir="${dirs.modules}">
				<include name="**"/>
			</fileset>
		</zipme>
		<zipme basedir="${dirs.plugins}" prefix="plugins/" destfile="${dirs.release}/com_akeebasubs-pro-${version}-no_framework.zip" includeemptydirs="true">
			<fileset dir="${dirs.plugins}">
				<include name="**"/>
			</fileset>
		</zipme>
	</target>
	
	<!--
	====================================================================================================
	Tasks - Documentation
	====================================================================================================
	-->
	
	<target name="documentation" description="The documentation"
		depends="doc-j-pdf,doc-j-import">
	</target>
	
	<target name="doc-j-pdf" description="Documentation for Joomla! in PDF format">
		<exec command="xsltproc --nonet --xinclude --novalid --stringparam img.src.path ${dirs.documentation}/ --stringparam body.start.indent 0 --stringparam variablelist.term.break.after 1 --stringparam variablelist.term.separator &quot;&quot; --stringparam variablelist.max.termlength 12 --stringparam section.autolabel 1 --stringparam toc.section.depth 5 --output ${dirs.release}/akeebasubs-guide.fo ${dirs.bin.dbxsl}/fo/docbook.xsl ${dirs.documentation}/akeebasubs-guide.xml" dir="${project.basedir}" />
		<exec command="fop -fo ${dirs.release}/akeebasubs-guide.fo -pdf ${dirs.release}/akeebasubs-guide.pdf" logoutput="true" />
		<delete file="${dirs.release}/akeebasubs-guide.fo" quiet="yes" />
	</target>
	
	<target name="doc-j-import" description="Documentation for Joomla! in DocImport format">
		<docexport
			version="${version}"
			outdir="${dirs.release}"
			xslstyleroot="${dirs.bin.dbxsl}"
			title="Akeeba Subscriptions User's Guide"
			docbookfile="${dirs.documentation}/akeebasubs-guide.xml"
			imagedir="images"
			docbookimages="images"
			package="akeebasubs-guide"
		/>
	</target>
	
	<!--
	====================================================================================================
	Tasks - Project management
	====================================================================================================
	-->
	
	<target name="ftpdeploy" depends="svn">
		<svnversion workingcopy="${dirs.root}" propertyname="svn.lastrevision" />
		<!-- Core release -->
		<echo>Uploading Core release</echo>
		<ftpdeploy
			host="${ftp.host}"
			port="${ftp.port}"
			username="${ftp.username}"
			password="${ftp.password}"
			dir="${ftp.dir}/akeebasubs/${svn.lastrevision}"
			mode="${ftp.mode}"
			level="debug">
			<fileset dir="${dirs.root}">
				<include name="CHANGELOG"/>
			</fileset>			
			<fileset dir="${dirs.release}">
				<include name="com_akeebasubs-core-*.zip"/>
			</fileset>			
		</ftpdeploy>
		<echo>Uploading Professional release</echo>
		<ftpdeploy
			host="${ftp.host}"
			port="${ftp.port}"
			username="${ftp.username}"
			password="${ftp.password}"
			dir="${ftp.dir}/aksubspro/${svn.lastrevision}"
			mode="${ftp.mode}"
			level="debug">
			<fileset dir="${dirs.root}">
				<include name="CHANGELOG"/>
			</fileset>			
			<fileset dir="${dirs.release}">
				<include name="com_akeebasubs-pro-*.zip"/>
			</fileset>			
		</ftpdeploy>
		<echo>All done. Have a cup of coffee and relax :)</echo>
	</target>
	
</project>
